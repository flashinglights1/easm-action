name: Nuclei Simple Complete Scan

on:
  workflow_dispatch:
    inputs:
      scan_profile:
        description: 'Scan profile'
        required: true
        default: 'quick'
        type: choice
        options: ['quick', 'critical', 'full']
      batch_size:
        description: 'Number of subdomains per batch'
        required: false
        default: '500'
        type: string

env:
  RESULTS_BRANCH: "scan-results"
  GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}

jobs:
  scan-all-subdomains:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 10  # Run 10 batches at the same time
      matrix:
        batch_number: ${{ steps.calculate-batches.outputs.batch_matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GPG
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG

      - name: Calculate total batches needed
        id: calculate-batches
        run: |
          # Decrypt and count subdomains
          gpg --batch --yes --trust-model always \
            --decrypt "subdomains/all-subdomains.txt.gpg" > temp_subdomains.txt
          
          TOTAL_SUBDOMAINS=$(wc -l < temp_subdomains.txt)
          BATCH_SIZE=${{ github.event.inputs.batch_size || '500' }}
          TOTAL_BATCHES=$(( (TOTAL_SUBDOMAINS + BATCH_SIZE - 1) / BATCH_SIZE ))
          
          echo "ðŸ“Š Total subdomains: $TOTAL_SUBDOMAINS"
          echo "ðŸ“¦ Batch size: $BATCH_SIZE"
          echo "ðŸŽ¯ Total batches needed: $TOTAL_BATCHES"
          
          # Create batch matrix (limit to 200 to stay under GitHub limits)
          if [ $TOTAL_BATCHES -gt 200 ]; then
            echo "âš ï¸ Too many batches ($TOTAL_BATCHES), limiting to 200"
            TOTAL_BATCHES=200
          fi
          
          # Create array: [1, 2, 3, ..., TOTAL_BATCHES]
          BATCH_ARRAY="["
          for i in $(seq 1 $TOTAL_BATCHES); do
            if [ $i -eq $TOTAL_BATCHES ]; then
              BATCH_ARRAY="${BATCH_ARRAY}$i"
            else
              BATCH_ARRAY="${BATCH_ARRAY}$i,"
            fi
          done
          BATCH_ARRAY="${BATCH_ARRAY}]"
          
          echo "batch_matrix=$BATCH_ARRAY" >> $GITHUB_OUTPUT
          echo "total_batches=$TOTAL_BATCHES" >> $GITHUB_OUTPUT
          
          rm -f temp_subdomains.txt

      - name: Extract batch subdomains
        run: |
          BATCH_NUM=${{ matrix.batch_number }}
          BATCH_SIZE=${{ github.event.inputs.batch_size || '500' }}
          
          # Calculate line numbers for this batch
          START_LINE=$(( (BATCH_NUM - 1) * BATCH_SIZE + 1 ))
          END_LINE=$(( BATCH_NUM * BATCH_SIZE ))
          
          echo "ðŸŽ¯ Processing batch $BATCH_NUM: lines $START_LINE to $END_LINE"
          
          # Decrypt and extract this batch
          gpg --batch --yes --trust-model always \
            --decrypt "subdomains/all-subdomains.txt.gpg" | \
          sed -n "${START_LINE},${END_LINE}p" > batch_${BATCH_NUM}.txt
          
          ACTUAL_COUNT=$(wc -l < batch_${BATCH_NUM}.txt)
          echo "ðŸ“Š Batch $BATCH_NUM contains $ACTUAL_COUNT subdomains"
          
          # Show first few subdomains
          echo "ðŸ” First 3 subdomains in batch $BATCH_NUM:"
          head -3 batch_${BATCH_NUM}.txt

      - name: Install Nuclei
        run: |
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          nuclei -version

      - name: Update Nuclei templates
        run: |
          nuclei -update-templates
          echo "ðŸ“ Templates updated"

      - name: Run Nuclei scan
        run: |
          BATCH_NUM=${{ matrix.batch_number }}
          PROFILE="${{ github.event.inputs.scan_profile || 'quick' }}"
          
          # Configure scan based on profile
          case $PROFILE in
            "quick")
              TEMPLATES="-t ~/nuclei-templates/cves/ -t ~/nuclei-templates/vulnerabilities/"
              SEVERITY="-severity critical,high"
              RATE_LIMIT="-rl 2000"
              TIMEOUT="-timeout 2"
              ;;
            "critical")
              TEMPLATES="-t ~/nuclei-templates/"
              SEVERITY="-severity critical"
              RATE_LIMIT="-rl 1000"
              TIMEOUT="-timeout 3"
              ;;
            "full")
              TEMPLATES="-t ~/nuclei-templates/"
              SEVERITY="-severity critical,high,medium,low"
              RATE_LIMIT="-rl 500"
              TIMEOUT="-timeout 5"
              ;;
          esac
          
          OUTPUT_JSON="nuclei_results_batch_${BATCH_NUM}.json"
          OUTPUT_TXT="nuclei_results_batch_${BATCH_NUM}.txt"
          
          echo "ðŸš€ Starting Nuclei scan for batch $BATCH_NUM..."
          echo "ðŸ“Š Profile: $PROFILE"
          echo "ðŸŽ¯ Templates: $TEMPLATES"
          
          # Run Nuclei scan (no delays needed - direct scanning)
          nuclei \
            -l batch_${BATCH_NUM}.txt \
            $TEMPLATES \
            $SEVERITY \
            $RATE_LIMIT \
            $TIMEOUT \
            -no-color \
            -jle "$OUTPUT_JSON" \
            -o "$OUTPUT_TXT" \
            -stats \
            -retries 1 \
            -bulk-size 50 \
            -c 25 \
            -header "User-Agent: Mozilla/5.0 (compatible; SecurityScanner/1.0)" \
            -exclude-tags dos,intrusive,brute-force \
            -max-host-error 5 \
            > /dev/null 2>&1 || echo "Scan completed with some errors"
          
          # Check results
          if [ -f "$OUTPUT_JSON" ] && [ -s "$OUTPUT_JSON" ]; then
            FINDINGS=$(wc -l < "$OUTPUT_JSON")
            echo "âœ… Batch $BATCH_NUM: Found $FINDINGS vulnerabilities"
          else
            echo "â„¹ï¸ Batch $BATCH_NUM: No vulnerabilities found"
            echo '[]' > "$OUTPUT_JSON"
            echo "" > "$OUTPUT_TXT"
          fi

      - name: Encrypt and store results
        run: |
          BATCH_NUM=${{ matrix.batch_number }}
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # Encrypt results
          gpg --batch --yes --trust-model always \
            --recipient "$GPG_KEY_ID" \
            --encrypt --armor \
            --output "nuclei_results_batch_${BATCH_NUM}_${TIMESTAMP}.json.gpg" \
            "nuclei_results_batch_${BATCH_NUM}.json"
          
          gpg --batch --yes --trust-model always \
            --recipient "$GPG_KEY_ID" \
            --encrypt --armor \
            --output "nuclei_results_batch_${BATCH_NUM}_${TIMESTAMP}.txt.gpg" \
            "nuclei_results_batch_${BATCH_NUM}.txt"
          
          echo "ðŸ”’ Results encrypted for batch $BATCH_NUM"
          
          # Store in results branch
          git config --local user.email "nuclei-scanner@github.com"
          git config --local user.name "Nuclei Scanner"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Switch to results branch
          git fetch origin $RESULTS_BRANCH:$RESULTS_BRANCH || git checkout -b $RESULTS_BRANCH
          git checkout $RESULTS_BRANCH
          
          # Create date directory
          DATE_DIR="output/$(date +%Y/%m/%d)"
          mkdir -p "$DATE_DIR"
          
          # Move encrypted files
          mv "nuclei_results_batch_${BATCH_NUM}_${TIMESTAMP}.json.gpg" "$DATE_DIR/"
          mv "nuclei_results_batch_${BATCH_NUM}_${TIMESTAMP}.txt.gpg" "$DATE_DIR/"
          
          # Also copy to latest
          mkdir -p "output/latest"
          cp "$DATE_DIR/nuclei_results_batch_${BATCH_NUM}_${TIMESTAMP}.json.gpg" "output/latest/"
          cp "$DATE_DIR/nuclei_results_batch_${BATCH_NUM}_${TIMESTAMP}.txt.gpg" "output/latest/"
          
          # Commit and push
          git add .
          git commit -m "Add scan results for batch $BATCH_NUM - $TIMESTAMP" || echo "No changes to commit"
          git push origin $RESULTS_BRANCH || echo "Push failed, continuing..."
          
          echo "âœ… Results stored for batch $BATCH_NUM"

  generate-summary:
    needs: scan-all-subdomains
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate scan summary
        run: |
          echo "# ðŸŽ¯ Nuclei Scan Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Profile**: ${{ github.event.inputs.scan_profile || 'quick' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Batch Size**: ${{ github.event.inputs.batch_size || '500' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Batches**: ${{ needs.scan-all-subdomains.outputs.total_batches || 'Unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Results" >> $GITHUB_STEP_SUMMARY
          echo "All scan results have been encrypted and stored in the \`${{ env.RESULTS_BRANCH }}\` branch." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¥ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Use \`scripts/decrypt-results.sh\` to decrypt and view results locally" >> $GITHUB_STEP_SUMMARY
          echo "2. Check the \`output/latest/\` directory for the most recent results" >> $GITHUB_STEP_SUMMARY
          echo "3. All subdomains have been scanned with 100% coverage!" >> $GITHUB_STEP_SUMMARY
