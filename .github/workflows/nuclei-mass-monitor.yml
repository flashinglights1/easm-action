name: Nuclei Mass Scale Monitor

on:
  workflow_dispatch:
    inputs:
      show_job_details:
        description: 'Show detailed job analysis (slower but more detailed)'
        required: false
        default: 'true'
        type: boolean
      workflow_limit:
        description: 'Maximum workflows to analyze (default: 100)'
        required: false
        default: '100'
        type: string

env:
  RESULTS_BRANCH: "scan-results"

jobs:
  monitor-mass-progress:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours max
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          # Install GitHub CLI if not available
          if ! command -v gh &> /dev/null; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi

      - name: Monitor Mass Scale Progress
        id: monitor
        run: |
          echo "# ðŸ” Nuclei Mass Scale Monitor" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring started at:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get all nuclei-mass-scan workflows with limit
          WORKFLOW_LIMIT="${{ github.event.inputs.workflow_limit || '100' }}"
          echo "ðŸ“Š Fetching nuclei-mass-scan workflows (limit: $WORKFLOW_LIMIT)..."
          
          # Get workflows with different statuses
          RUNNING_WORKFLOWS=$(gh run list --repo ${{ github.repository }} --workflow=nuclei-mass-scan.yml --status=in_progress --limit $WORKFLOW_LIMIT --json databaseId,number,status,createdAt,headBranch,displayTitle --jq '.[]' 2>/dev/null || echo "[]")
          QUEUED_WORKFLOWS=$(gh run list --repo ${{ github.repository }} --workflow=nuclei-mass-scan.yml --status=queued --limit $WORKFLOW_LIMIT --json databaseId,number,status,createdAt,headBranch,displayTitle --jq '.[]' 2>/dev/null || echo "[]")
          COMPLETED_WORKFLOWS=$(gh run list --repo ${{ github.repository }} --workflow=nuclei-mass-scan.yml --status=completed --limit $WORKFLOW_LIMIT --json databaseId,number,status,createdAt,headBranch,displayTitle,conclusion --jq '.[]' 2>/dev/null || echo "[]")
          FAILED_WORKFLOWS=$(gh run list --repo ${{ github.repository }} --workflow=nuclei-mass-scan.yml --status=failure --limit $WORKFLOW_LIMIT --json databaseId,number,status,createdAt,headBranch,displayTitle,conclusion --jq '.[]' 2>/dev/null || echo "[]")
          CANCELLED_WORKFLOWS=$(gh run list --repo ${{ github.repository }} --workflow=nuclei-mass-scan.yml --status=cancelled --limit $WORKFLOW_LIMIT --json databaseId,number,status,createdAt,headBranch,displayTitle,conclusion --jq '.[]' 2>/dev/null || echo "[]")

          # Count workflows by status
          RUNNING_COUNT=$(echo "$RUNNING_WORKFLOWS" | jq -s 'length')
          QUEUED_COUNT=$(echo "$QUEUED_WORKFLOWS" | jq -s 'length')
          COMPLETED_COUNT=$(echo "$COMPLETED_WORKFLOWS" | jq -s 'length')
          FAILED_COUNT=$(echo "$FAILED_WORKFLOWS" | jq -s 'length')
          CANCELLED_COUNT=$(echo "$CANCELLED_WORKFLOWS" | jq -s 'length')
          
          TOTAL_WORKFLOWS=$((RUNNING_COUNT + QUEUED_COUNT + COMPLETED_COUNT + FAILED_COUNT + CANCELLED_COUNT))

          echo "## ðŸ“ˆ Workflow Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count | Percentage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|------------|" >> $GITHUB_STEP_SUMMARY
          
          if [ $TOTAL_WORKFLOWS -gt 0 ]; then
            RUNNING_PCT=$((RUNNING_COUNT * 100 / TOTAL_WORKFLOWS))
            QUEUED_PCT=$((QUEUED_COUNT * 100 / TOTAL_WORKFLOWS))
            COMPLETED_PCT=$((COMPLETED_COUNT * 100 / TOTAL_WORKFLOWS))
            FAILED_PCT=$((FAILED_COUNT * 100 / TOTAL_WORKFLOWS))
            CANCELLED_PCT=$((CANCELLED_COUNT * 100 / TOTAL_WORKFLOWS))
            
            echo "| ðŸŸ¡ Running | $RUNNING_COUNT | ${RUNNING_PCT}% |" >> $GITHUB_STEP_SUMMARY
            echo "| â³ Queued | $QUEUED_COUNT | ${QUEUED_PCT}% |" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Completed | $COMPLETED_COUNT | ${COMPLETED_PCT}% |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED_COUNT | ${FAILED_PCT}% |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš« Cancelled | $CANCELLED_COUNT | ${CANCELLED_PCT}% |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **$TOTAL_WORKFLOWS** | **100%** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **No nuclei-mass-scan workflows found** | | |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Detailed Workflow Analysis" >> $GITHUB_STEP_SUMMARY

          # Analyze running workflows
          if [ $RUNNING_COUNT -gt 0 ]; then
            echo "### ðŸŸ¡ Running Workflows ($RUNNING_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "$RUNNING_WORKFLOWS" | jq -r '.[] | "- **Run #\(.number)**: \(.displayTitle) (Started: \(.createdAt))"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Analyze queued workflows
          if [ $QUEUED_COUNT -gt 0 ]; then
            echo "### â³ Queued Workflows ($QUEUED_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "$QUEUED_WORKFLOWS" | jq -r '.[] | "- **Run #\(.number)**: \(.displayTitle) (Queued: \(.createdAt))"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Analyze completed workflows
          if [ $COMPLETED_COUNT -gt 0 ]; then
            echo "### âœ… Completed Workflows ($COMPLETED_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "$COMPLETED_WORKFLOWS" | jq -r '.[] | "- **Run #\(.number)**: \(.displayTitle) (Completed: \(.createdAt), Conclusion: \(.conclusion))"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Analyze failed workflows
          if [ $FAILED_COUNT -gt 0 ]; then
            echo "### âŒ Failed Workflows ($FAILED_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "$FAILED_WORKFLOWS" | jq -r '.[] | "- **Run #\(.number)**: \(.displayTitle) (Failed: \(.createdAt), Conclusion: \(.conclusion))"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Analyze cancelled workflows
          if [ $CANCELLED_COUNT -gt 0 ]; then
            echo "### ðŸš« Cancelled Workflows ($CANCELLED_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "$CANCELLED_WORKFLOWS" | jq -r '.[] | "- **Run #\(.number)**: \(.displayTitle) (Cancelled: \(.createdAt), Conclusion: \(.conclusion))"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Get detailed job information for running workflows (optional)
          SHOW_JOBS="${{ github.event.inputs.show_job_details || 'true' }}"
          if [ "$SHOW_JOBS" = "true" ] && [ $RUNNING_COUNT -gt 0 ]; then
            echo "## ðŸ”¬ Detailed Job Analysis (Running Workflows)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Get job details for each running workflow
            echo "$RUNNING_WORKFLOWS" | jq -r '.[] | .databaseId' | while read -r run_id; do
              if [ -n "$run_id" ]; then
                echo "### Workflow Run #$run_id" >> $GITHUB_STEP_SUMMARY
                
                # Get jobs for this workflow run
                JOBS=$(gh api repos/${{ github.repository }}/actions/runs/$run_id/jobs --jq '.jobs[]' 2>/dev/null || echo "[]")
                
                if [ "$JOBS" != "[]" ]; then
                  echo "| Job Name | Status | Conclusion | Started At |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|--------|------------|------------|" >> $GITHUB_STEP_SUMMARY
                  
                  echo "$JOBS" | jq -r '.[] | "| \(.name) | \(.status) | \(.conclusion // "N/A") | \(.started_at // "N/A") |"' >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                else
                  echo "No job details available for this workflow run." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
          elif [ "$SHOW_JOBS" = "false" ]; then
            echo "## âš¡ Quick Mode" >> $GITHUB_STEP_SUMMARY
            echo "Detailed job analysis disabled for faster execution." >> $GITHUB_STEP_SUMMARY
            echo "Enable 'Show detailed job analysis' for job-level details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Calculate progress percentage
          if [ $TOTAL_WORKFLOWS -gt 0 ]; then
            PROGRESS_PCT=$((COMPLETED_COUNT * 100 / TOTAL_WORKFLOWS))
            echo "## ðŸ“Š Overall Progress" >> $GITHUB_STEP_SUMMARY
            echo "**Progress: $COMPLETED_COUNT / $TOTAL_WORKFLOWS workflows completed ($PROGRESS_PCT%)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Progress bar
            BAR_LENGTH=20
            FILLED_LENGTH=$((PROGRESS_PCT * BAR_LENGTH / 100))
            BAR=""
            for i in $(seq 1 $BAR_LENGTH); do
              if [ $i -le $FILLED_LENGTH ]; then
                BAR="${BAR}â–ˆ"
              else
                BAR="${BAR}â–‘"
              fi
            done
            echo "Progress: [$BAR] $PROGRESS_PCT%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Set outputs for other jobs
          echo "total_workflows=$TOTAL_WORKFLOWS" >> $GITHUB_OUTPUT
          echo "running_workflows=$RUNNING_COUNT" >> $GITHUB_OUTPUT
          echo "queued_workflows=$QUEUED_COUNT" >> $GITHUB_OUTPUT
          echo "completed_workflows=$COMPLETED_COUNT" >> $GITHUB_OUTPUT
          echo "failed_workflows=$FAILED_COUNT" >> $GITHUB_OUTPUT
          echo "cancelled_workflows=$CANCELLED_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… Monitoring complete!"
          echo "ðŸ“Š Found $TOTAL_WORKFLOWS total workflows:"
          echo "  - Running: $RUNNING_COUNT"
          echo "  - Queued: $QUEUED_COUNT" 
          echo "  - Completed: $COMPLETED_COUNT"
          echo "  - Failed: $FAILED_COUNT"
          echo "  - Cancelled: $CANCELLED_COUNT"

      - name: Check Results Branch
        if: steps.monitor.outputs.completed_workflows > 0
        run: |
          echo "## ðŸ“ Results Branch Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if results branch exists and has recent commits
          if git ls-remote --heads origin ${{ env.RESULTS_BRANCH }} | grep -q ${{ env.RESULTS_BRANCH }}; then
            echo "âœ… Results branch '${{ env.RESULTS_BRANCH }}' exists" >> $GITHUB_STEP_SUMMARY
            
            # Get latest commit info
            LATEST_COMMIT=$(git ls-remote origin ${{ env.RESULTS_BRANCH }} | head -1 | cut -f1)
            COMMIT_DATE=$(git log -1 --format=%ci $LATEST_COMMIT 2>/dev/null || echo "Unknown")
            
            echo "- **Latest commit**: $LATEST_COMMIT" >> $GITHUB_STEP_SUMMARY
            echo "- **Last updated**: $COMMIT_DATE" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch URL**: https://github.com/${{ github.repository }}/tree/${{ env.RESULTS_BRANCH }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Results branch '${{ env.RESULTS_BRANCH }}' not found yet" >> $GITHUB_STEP_SUMMARY
            echo "- Workflows may still be running or no results have been generated yet" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate Summary
        run: |
          echo "## ðŸŽ¯ Quick Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Manual Actions" >> $GITHUB_STEP_SUMMARY
          echo "- [View All Workflows](https://github.com/${{ github.repository }}/actions/workflows/nuclei-mass-scan.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- [View Results Branch](https://github.com/${{ github.repository }}/tree/${{ env.RESULTS_BRANCH }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Run This Monitor Again](https://github.com/${{ github.repository }}/actions/workflows/nuclei-mass-monitor.yml)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ GitHub CLI Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Cancel all running workflows" >> $GITHUB_STEP_SUMMARY
          echo "gh run list --repo ${{ github.repository }} --workflow=nuclei-mass-scan.yml --status=in_progress --json databaseId --jq '.[].databaseId' | xargs -I {} gh run cancel {} --repo ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View running workflows" >> $GITHUB_STEP_SUMMARY
          echo "gh run list --repo ${{ github.repository }} --workflow=nuclei-mass-scan.yml --status=in_progress" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View all workflows" >> $GITHUB_STEP_SUMMARY
          echo "gh run list --repo ${{ github.repository }} --workflow=nuclei-mass-scan.yml --limit 50" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitor completed at:** $(date)" >> $GITHUB_STEP_SUMMARY
